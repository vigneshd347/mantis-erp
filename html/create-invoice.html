<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Invoice - Manti ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            background-color: #f3f4f6;
        }

        :root {
            --manti-blue: #2A2C7A;
            --manti-dark: #414142;
        }

        .bg-manti-blue {
            background-color: var(--manti-blue);
        }

        .text-manti-blue {
            color: var(--manti-blue);
        }

        .bg-manti-orange-gradient {
            background: linear-gradient(90deg, #df2726 0%, #e63e2e 42%, #f2673d 100%);
        }

        .text-manti-orange {
            color: #df2726;
        }

        .border-manti-orange {
            border-color: #df2726;
        }

        .bg-manti-dark {
            background-color: var(--manti-dark);
        }

        .print-only {
            display: none;
        }

        @media print {
            .no-print {
                display: none !important;
            }

            .print-only {
                display: block !important;
            }

            body {
                background: white;
            }

            #invoice-content {
                box-shadow: none;
                border: none;
                margin: 0;
                width: 100%;
            }
        }

        table,
        th,
        td {
            border: 1px solid #9CA3AF;
            border-collapse: collapse;
        }

        th {
            border: 1px solid white;
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-box {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 99999;
            animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        /* PAID Stamp */
        .paid-stamp {
            border: 4px solid #ef4444;
            color: #ef4444;
            font-size: 24px;
            font-weight: 900;
            padding: 4px 12px;
            text-transform: uppercase;
            transform: rotate(-15deg);
            border-radius: 8px;
            opacity: 0.8;
            display: none;
            user-select: none;
        }

        .payment-paid .paid-stamp {
            display: block;
        }

        .payment-paid #qrcode,
        .payment-paid #qr-label {
            display: none;
        }

        @media print {
            .toast {
                display: none !important;
            }
        }

        .toast-success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .toast-error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        @keyframes toastIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes toastOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        /* Notification Status Modal */
        #notificationStatusModal .status-step {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding: 8px;
            border-radius: 8px;
        }

        #notificationStatusModal .status-step .icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #e5e7eb;
            font-size: 14px;
        }

        #notificationStatusModal .status-step.completed .icon {
            background: #22c55e;
            color: white;
        }

        #notificationStatusModal .status-step.pending .icon {
            background: #3b82f6;
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }
    </style>
</head>

<body class="text-gray-900 text-xs">

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-slate-900 text-white hidden md:flex flex-col no-print">
            <div class="p-6 border-b border-slate-800">
                <a href="dashboard.html" class="text-xl font-bold tracking-widest text-amber-500 uppercase">MANTI
                    ERP</a>
            </div>
            <nav class="flex-1 px-4 py-4 space-y-2">
                <a href="dashboard.html"
                    class="flex items-center px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800"><span
                        class="mr-3">üìä</span> Dashboard</a>
                <a href="create-invoice.html"
                    class="flex items-center px-4 py-3 rounded-lg bg-slate-800 text-white font-medium border-l-4 border-amber-500"><span
                        class="mr-3">üßæ</span> New Invoice</a>
                <a href="rate-update.html"
                    class="flex items-center px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800"><span
                        class="mr-3">üí∞</span> Rate Update</a>
                <a href="products.html"
                    class="flex items-center px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800"><span
                        class="mr-3">üíç</span> Products</a>
                <a href="backup.html"
                    class="flex items-center px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800"><span
                        class="mr-3">üíæ</span> Data Backup</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8">
            <div class="max-w-[210mm] mx-auto">
                <div class="flex justify-between items-center mb-6 no-print">
                    <h1 class="text-2xl font-bold text-gray-800">New Sales Invoice</h1>
                    <div class="space-x-2 flex items-center">
                        <div id="supabase-status"
                            class="flex items-center gap-2 px-3 py-1 rounded bg-gray-100 text-[10px] font-bold no-print">
                            <span class="status-dot w-2 h-2 rounded-full bg-gray-400"></span>
                            <span class="status-text text-gray-600">Checking Cloud...</span>
                        </div>
                        <button onclick="window.history.back()"
                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">Cancel</button>
                        <button onclick="saveAndPrintInvoice()"
                            class="px-5 py-2 bg-indigo-600 text-white rounded shadow-lg hover:bg-indigo-700 transition flex items-center gap-2">
                            <span>üíæ</span> Save & Print Invoice
                        </button>
                    </div>
                </div>

                <!-- Invoice Template -->
                <div id="invoice-content" class="bg-white shadow-xl min-h-[297mm] relative flex flex-col">

                    <!-- Header Section -->
                    <div class="relative w-full h-[210px]">

                        <!-- Logo (Left) -->
                        <div class="absolute left-4 top-3 z-30">
                            <img src="images/logo.png" class="h-[75px] w-auto object-contain" alt="Manti Jewel Art">
                        </div>

                        <!-- Top Right: TAX INVOICE Title -->
                        <div class="absolute right-8 top-4 text-right z-10">
                            <h2 class="text-4xl font-black text-manti-blue tracking-wide">TAX INVOICE</h2>
                        </div>

                        <!-- Stacked Bars Layout -->
                        <div class="absolute top-[0px] w-full h-full z-0 pointer-events-none">

                            <!-- Orange Bar (Address) - Right Side -->
                            <div class="absolute right-0 top-[65px] h-[75px] w-[55%] bg-manti-orange-gradient text-white flex items-center justify-end pl-8 pr-8 z-10"
                                style="clip-path: polygon(30% 0, 100% 0, 100% 100%, 5% 100%);">
                                <div class="flex flex-col text-[11px] leading-snug font-semibold text-right w-full">
                                    <div class="flex justify-end items-start mb-1">
                                        <span class="text-right">üìç No. 12/189, Prv Complex, Vannan Kovil
                                            Junction,<br>Mettupalayam Rd, Coimbatore, Tamil Nadu - 641047.</span>
                                    </div>
                                    <div class="flex justify-end items-center">
                                        <span>üìû +91 90927 27655</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Blue Bar (Company Name) - Left Side -->
                            <div class="absolute left-0 top-[115px] h-[48px] w-[55%] bg-manti-blue text-white flex items-center pl-4 z-20"
                                style="clip-path: polygon(0 0, 100% 0, 88% 100%, 0% 100%);">
                                <h1 class="text-[15px] font-extrabold tracking-[0.15em] uppercase whitespace-nowrap">
                                    MANTI JEWEL ART PRIVATE LIMITED</h1>
                            </div>

                            <!-- GSTIN Strip (Orange) - Below Blue Bar -->
                            <div class="absolute left-0 top-[163px] h-[28px] w-[40%] bg-manti-orange-gradient text-white flex items-center pl-4 z-10"
                                style="clip-path: polygon(0 0, 100% 0, 90% 100%, 0% 100%);">
                                <span class="font-bold tracking-wide text-[11px]">GSTIN : 33AAUCM3607L1Z3</span>
                            </div>
                        </div>
                    </div>

                    <!-- Details Grid -->
                    <div class="flex justify-between px-8 py-4 mt-2">
                        <!-- Left Column (Bill/Ship) -->
                        <div class="w-[48%] space-y-4">
                            <!-- Bill To -->
                            <div>
                                <h3
                                    class="font-bold text-manti-blue mb-1 border-b border-manti-orange inline-block w-full">
                                    Bill To</h3>
                                <div class="grid grid-cols-[60px_10px_1fr] gap-0 text-gray-800 font-medium">
                                    <div>Name</div>
                                    <div>:</div>
                                    <input type="text" id="billName"
                                        class="w-full bg-transparent border-none p-0 h-4 focus:ring-0"
                                        placeholder="Customer Name">

                                    <div>Address</div>
                                    <div>:</div>
                                    <textarea id="billAddress" rows="2"
                                        class="w-full bg-transparent border-none p-0 resize-none leading-tight focus:ring-0"
                                        placeholder="Address"></textarea>

                                    <div>State</div>
                                    <div>:</div>
                                    <input type="text" id="billState" value="Tamil Nadu"
                                        class="w-full bg-transparent border-none p-0 h-4 focus:ring-0">

                                    <div>GSTIN</div>
                                    <div>:</div>
                                    <input type="text" id="billGst"
                                        class="w-full bg-transparent border-none p-0 h-4 focus:ring-0"
                                        placeholder="GSTIN">

                                    <div>Mobile</div>
                                    <div>:</div>
                                    <input type="tel" id="billMobile"
                                        class="w-full bg-transparent border-none p-0 h-4 focus:ring-0"
                                        placeholder="Mobile Number">

                                    <div>Email</div>
                                    <div>:</div>
                                    <input type="email" id="billEmail"
                                        class="w-full bg-transparent border-none p-0 h-4 focus:ring-0"
                                        placeholder="Email Address">
                                </div>
                            </div>

                            <!-- Ship To -->
                            <div>
                                <div class="flex items-center justify-between border-b border-manti-orange mb-1">
                                    <h3 class="font-bold text-manti-blue">Shipp To</h3>
                                    <label class="flex items-center space-x-1 cursor-pointer">
                                        <input type="checkbox" id="sameAsBill" onchange="copyBillToShip()"
                                            class="w-3 h-3 text-manti-blue rounded focus:ring-0">
                                        <span class="text-[9px] font-bold text-gray-600">Same as Bill To</span>
                                    </label>
                                </div>
                                <div class="grid grid-cols-[60px_10px_1fr] gap-0 text-gray-800 font-medium">
                                    <div>Name</div>
                                    <div>:</div>
                                    <input type="text" id="shipName"
                                        class="w-full bg-transparent border-none p-0 h-4 focus:ring-0"
                                        placeholder="Name">

                                    <div>Address</div>
                                    <div>:</div>
                                    <textarea id="shipAddress" rows="2"
                                        class="w-full bg-transparent border-none p-0 resize-none leading-tight focus:ring-0"
                                        placeholder="Address"></textarea>

                                    <div>State</div>
                                    <div>:</div>
                                    <input type="text" id="shipState" value="Tamil Nadu"
                                        class="w-full bg-transparent border-none p-0 h-4 focus:ring-0">

                                    <div>Mobile</div>
                                    <div>:</div>
                                    <input type="tel" id="shipMobile"
                                        class="w-full bg-transparent border-none p-0 h-4 focus:ring-0"
                                        placeholder="Mobile Number">

                                    <div>Email</div>
                                    <div>:</div>
                                    <input type="email" id="shipEmail"
                                        class="w-full bg-transparent border-none p-0 h-4 focus:ring-0"
                                        placeholder="Email Address">
                                </div>
                            </div>
                        </div>

                        <!-- Right Column (Invoice Details) -->
                        <div class="w-[45%] pl-4">
                            <div class="grid grid-cols-[100px_10px_1fr] gap-y-1 text-gray-800 font-medium">
                                <div class="font-bold"># Inv. No</div>
                                <div>:</div>
                                <input type="text" id="invNo" readonly
                                    class="font-bold bg-gray-100 border border-gray-300 rounded px-1 p-0 h-5 focus:ring-0 cursor-not-allowed text-manti-blue"
                                    title="Invoice number is auto-generated">

                                <div class="font-bold">Inv. Date</div>
                                <div>:</div>
                                <input type="date" id="invDate" class="bg-transparent border-none p-0 h-4 focus:ring-0">

                                <div class="font-bold">Payment Mode</div>
                                <div>:</div>
                                <select id="paymentMode"
                                    class="bg-transparent border-none p-0 h-5 focus:ring-0 w-full text-xs font-medium">
                                    <option value="Cash">Cash</option>
                                    <option value="UPI">UPI</option>
                                    <option value="Card">Card</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                </select>

                                <div class="font-bold no-print">Payment Status</div>
                                <div class="no-print">:</div>
                                <select id="paymentStatus" onchange="updatePaymentUI()"
                                    class="bg-transparent border-none p-0 h-5 focus:ring-0 w-full text-xs font-bold text-green-600 no-print">
                                    <option value="Paid">Paid</option>
                                    <option value="Payment Pending">Payment Pending</option>
                                </select>
                            </div>

                            <div class="h-px bg-manti-orange w-full my-3"></div>

                            <div class="grid grid-cols-[100px_10px_1fr] gap-y-1 text-gray-800 font-medium">
                                <div class="font-bold">Buyer's Order No</div>
                                <div>:</div>
                                <input type="text" class="bg-transparent border-none p-0 h-4 focus:ring-0">

                                <div class="font-bold">Supplier's Ref.</div>
                                <div>:</div>
                                <input type="text" class="bg-transparent border-none p-0 h-4 focus:ring-0">

                                <div class="font-bold">Vehicle Number</div>
                                <div>:</div>
                                <input type="text" id="vehicleNo"
                                    class="bg-transparent border-none p-0 h-4 focus:ring-0 transition-colors duration-300">

                                <div class="font-bold">Delivery Date</div>
                                <div>:</div>
                                <input type="text" value="dd/mm/yyyy"
                                    class="bg-transparent border-none p-0 h-4 focus:ring-0">

                                <div class="font-bold">Transport Details</div>
                                <div>:</div>
                                <input type="text" id="transportDetails"
                                    class="bg-transparent border-none p-0 h-4 focus:ring-0 transition-colors duration-300">
                            </div>
                        </div>
                    </div>

                    <!-- Items Table -->
                    <div class="px-8 mt-2 flex-grow flex flex-col relative z-20">
                        <table class="w-full border-collapse text-[11px]">
                            <thead>
                                <tr class="bg-manti-dark text-white h-9">
                                    <th class="w-8">Sr</th>
                                    <th class="text-left pl-2">Goods & Service Description</th>
                                    <th class="w-14">HSN</th>
                                    <th class="w-24">Metal Type</th>
                                    <th class="w-16">Weight(g)</th>
                                    <th class="w-20">Rate</th>
                                    <th class="w-20">MC(%)</th>
                                    <th class="w-24">Total</th>
                                    <th class="w-6 no-print bg-white border-0"></th>
                                </tr>
                            </thead>
                            <tbody id="invoiceItems">
                                <tr class="h-8 align-top">
                                    <td class="text-center py-1 font-bold">1</td>
                                    <td class="pl-2 py-1">
                                        <input type="text"
                                            class="w-full bg-transparent font-bold focus:outline-none desc"
                                            placeholder="Enter item description">
                                    </td>
                                    <td class="text-center py-1">
                                        <input type="text"
                                            class="w-full text-center bg-transparent focus:outline-none hsn"
                                            value="7113">
                                    </td>
                                    <td class="text-center py-1">
                                        <select
                                            class="w-full bg-transparent text-center focus:outline-none metal-type text-[10px]"
                                            onchange="onMetalTypeChange(this)">
                                            <option value="Pure Gold">Pure Gold</option>
                                            <option value="Pure Silver">Pure Silver</option>
                                            <option value="Gold(22K)">Gold(22K)</option>
                                            <option value="Silver(925)">Silver(925)</option>
                                        </select>
                                    </td>
                                    <td class="text-center py-1">
                                        <input type="number" step="0.001"
                                            class="w-full text-center bg-transparent weight" placeholder="0.000"
                                            oninput="calculate(this)">
                                    </td>
                                    <td class="text-right pr-1 py-1">
                                        <input type="number"
                                            class="w-full text-right bg-transparent rate bg-gray-50 cursor-not-allowed"
                                            readonly placeholder="Auto">
                                    </td>
                                    <td class="text-center py-1">
                                        <input type="number" class="w-full text-center bg-transparent mc"
                                            oninput="calculate(this)" placeholder="%" value="0">
                                    </td>
                                    <td class="text-right pr-1 py-1 font-bold total">0.00</td>
                                    <td class="text-center no-print border-0"><button onclick="removeRow(this)"
                                            class="text-red-500 font-bold">&times;</button></td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr class="font-bold bg-gray-50 h-8">
                                    <td colspan="7" class="text-right pr-2">Sub-Total:</td>
                                    <td class="text-right pr-2" id="subTotalTotal">0.00</td>
                                    <td class="no-print border-0"></td>
                                </tr>
                            </tfoot>
                        </table>
                        <button onclick="addRow()"
                            class="mt-2 text-blue-600 underline text-xs font-bold no-print self-start">+ Add
                            Item</button>

                        <!-- Watermark -->
                        <div
                            class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-[0.04] z-0">
                            <img src="images/logo.png" class="w-[450px] h-[450px] grayscale object-contain">
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="px-8 mt-auto w-full">
                        <div class="flex justify-between items-start pt-2 border-t border-gray-800 mt-4">
                            <!-- Bank Details -->
                            <div class="w-[45%] flex space-x-4">
                                <div>
                                    <h4 class="font-bold text-manti-blue text-sm uppercase mb-1">Our Bank Details</h4>
                                    <div
                                        class="grid grid-cols-[80px_10px_1fr] gap-y-0 text-gray-800 font-medium leading-relaxed">
                                        <div>Bank Name</div>
                                        <div>:</div>
                                        <div>IDFC FIRST</div>
                                        <div>Branch</div>
                                        <div>:</div>
                                        <div>POLLACHI BRANCH</div>
                                        <div>Account No</div>
                                        <div>:</div>
                                        <div>70008000727</div>
                                        <div>IFSC Code</div>
                                        <div>:</div>
                                        <div>IDFB0080538</div>
                                        <div>UPI ID</div>
                                        <div>:</div>
                                        <div>mantijwewlartpvt@idfcbank</div>
                                    </div>
                                    <div class="mt-2 text-xs border-t border-gray-300 pt-1">
                                        <span class="font-bold">Invoice Total in Word :</span><br>
                                        <span class="italic font-bold text-sm text-manti-blue" id="amountInWords">Zero
                                            Rupees Only</span>
                                    </div>
                                </div>
                                <!-- QR Code Container -->
                                <div id="qrCodeContainer"
                                    class="flex flex-col items-center justify-center pt-2 relative min-w-[100px]">
                                    <div id="qrcode" class="mb-1 p-1 bg-white border border-gray-200"></div>
                                    <span id="qr-label"
                                        class="text-[9px] font-bold text-manti-blue uppercase tracking-wide">Scan to
                                        Pay</span>
                                    <div
                                        class="paid-stamp absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none">
                                        PAID</div>
                                </div>
                            </div>

                            <!-- Summary -->
                            <div class="w-[40%] flex flex-col items-end">
                                <h4 class="font-bold text-manti-blue text-sm uppercase mb-1 w-full text-right">Summery
                                </h4>
                                <div
                                    class="grid grid-cols-[1fr_10px_80px] gap-y-1 w-full text-right text-gray-800 font-medium">
                                    <div>CGST Amt</div>
                                    <div>:</div>
                                    <div id="cgstTotal">0.00</div>
                                    <div>SGST Amt</div>
                                    <div>:</div>
                                    <div id="sgstTotal">0.00</div>
                                    <div>IGST Amt</div>
                                    <div>:</div>
                                    <div>-</div>
                                    <div>Freight Packing Charges</div>
                                    <div>:</div>
                                    <div>0.00</div>
                                    <div>Round off</div>
                                    <div>:</div>
                                    <div id="roundOff">0.00</div>
                                    <div class="col-span-3 border-t border-gray-800 my-1"></div>
                                    <div class="font-bold text-manti-blue">Total Amount</div>
                                    <div>:</div>
                                    <div class="font-bold text-manti-blue text-sm" id="grandTotal">0.00</div>
                                </div>

                                <div class="mt-8 text-center w-full">
                                    <p class="text-[10px] font-bold">For, MANTI JEWEL ART PRIVATE LIMITED</p>
                                    <div class="h-10"></div>
                                    <p class="text-[10px]">Authorised Signatory</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer Bar -->
                    <div
                        class="bg-manti-orange-gradient text-white text-center py-1 mt-2 font-bold tracking-widest text-[10px]">
                        Thank You For Business With US!
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Share Modal (after save) -->
    <div id="shareModal" class="modal-overlay no-print">
        <div class="modal-box text-center">
            <div class="text-5xl mb-4">‚úÖ</div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">Invoice Saved Successfully!</h2>
            <p class="text-sm text-gray-500 mb-1" id="savedInvNo"></p>
            <p class="text-sm text-gray-500 mb-6">Share the invoice with the customer:</p>
            <div class="flex gap-3 justify-center mb-4">
                <button onclick="sendWhatsApp()"
                    class="flex items-center gap-2 px-5 py-3 bg-green-500 text-white rounded-xl font-bold hover:bg-green-600 transition shadow-lg">
                    <span class="text-xl">üì±</span> WhatsApp
                </button>
                <button onclick="sendEmail()"
                    class="flex items-center gap-2 px-5 py-3 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600 transition shadow-lg">
                    <span class="text-xl">üìß</span> Email
                </button>
            </div>
            <button onclick="closeShareModal()" class="text-sm text-gray-400 hover:text-gray-600 underline">Skip &
                Close</button>
        </div>
    </div>

    <!-- Notification Status Modal -->
    <div id="notificationStatusModal" class="modal-overlay no-print">
        <div class="modal-box">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Processing Invoice</h2>
            <div id="statusSteps">
                <div class="status-step" id="step-db">
                    <div class="icon">üíæ</div>
                    <div class="text-sm font-medium">Syncing to Database...</div>
                </div>
                <div class="status-step" id="step-pdf">
                    <div class="icon">üìÑ</div>
                    <div class="text-sm font-medium">Generating PDF Invoice...</div>
                </div>
                <div class="status-step" id="step-upload">
                    <div class="icon">‚òÅÔ∏è</div>
                    <div class="text-sm font-medium">Uploading to Cloud Storage...</div>
                </div>
                <div class="status-step" id="step-email">
                    <div class="icon">üìß</div>
                    <div class="text-sm font-medium">Sending Email Notification...</div>
                </div>
                <div class="status-step" id="step-sms">
                    <div class="icon">üì±</div>
                    <div class="text-sm font-medium">Sending SMS Notification...</div>
                </div>
            </div>
            <div class="mt-6 flex justify-center">
                <button id="closeStatusBtn" onclick="closeStatusModal()"
                    class="hidden px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-bold">Done</button>
            </div>
        </div>
    </div>

    <!-- Admin Auth Modal -->
    <div id="adminModal" class="modal-overlay no-print">
        <div class="modal-box">
            <h2 class="text-xl font-bold text-gray-800 mb-2">üîê Admin Access Required</h2>
            <p class="text-sm text-gray-500 mb-4">Only admin can edit or delete invoices. Enter the admin password:</p>
            <input type="password" id="adminPassword" placeholder="Enter admin password"
                class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 mb-4 focus:border-indigo-500 focus:outline-none text-sm">
            <div class="flex gap-3">
                <button onclick="closeAdminModal()"
                    class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300">Cancel</button>
                <button onclick="verifyAdmin()"
                    class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700">Verify</button>
            </div>
        </div>
    </div>

    <!-- Logic Script -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/cloud-sync.js"></script>
    <script src="js/pdf-service.js"></script>
    <script src="js/notification-service.js"></script>
    <script>
        // ===== INVOICE NUMBER SYSTEM =====
        const INVOICE_PREFIX = 'INV-';
        const ADMIN_PASSWORD = 'manti@admin'; // Change this to your desired admin password

        function getNextInvoiceNumber() {
            let lastNum = parseInt(localStorage.getItem('lastInvoiceNumber')) || 0;
            lastNum++;
            const invNo = INVOICE_PREFIX + String(lastNum).padStart(5, '0');
            return { number: lastNum, display: invNo };
        }

        function initInvoiceNumber() {
            const result = getNextInvoiceNumber();
            document.getElementById('invNo').value = result.display;

            // Set default date
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            document.getElementById('invDate').value = `${year}-${month}-${day}`;
        }

        async function initPage() {
            initInvoiceNumber();
            loadRatesForAllRows();
            updateQRCode();
            updatePaymentUI();

            // Test Supabase Connection
            const statusIndicator = document.getElementById('supabase-status');
            const dot = statusIndicator.querySelector('.status-dot');
            const text = statusIndicator.querySelector('.status-text');

            try {
                const result = await CloudSync.testConnection();
                if (result.success) {
                    dot.className = "status-dot w-2 h-2 rounded-full bg-green-500";
                    text.textContent = "Cloud Connected";
                    text.className = "status-text text-green-600";
                } else {
                    dot.className = "status-dot w-2 h-2 rounded-full bg-red-500";
                    text.textContent = "Cloud Error";
                    text.className = "status-text text-red-600";
                    console.error("Supabase Connection Error:", result.message);
                }
            } catch (err) {
                dot.className = "status-dot w-2 h-2 rounded-full bg-red-500";
                text.textContent = "Cloud Offline";
                text.className = "status-text text-red-600";
            }
        }

        window.onload = initPage;

        // ===== SAVE & PRINT =====
        async function saveAndPrintInvoice() {
            // Validate required fields
            const errors = validateInvoice();
            if (errors.length > 0) {
                showToast(errors[0], 'error');
                return;
            }

            // Show Processing Modal Immediately
            const modal = document.getElementById('notificationStatusModal');
            modal.classList.add('active');
            document.getElementById('closeStatusBtn').classList.add('hidden');

            // Collect all invoice data
            const invoiceData = collectInvoiceData();

            // Start Parallel Processes
            const dbPromise = saveInvoiceWithStatus(invoiceData);
            const notificationPromise = startNotificationFlow(invoiceData);

            // Wait for DB save, but don't crash if it fails (it will update its own status)
            const dbResult = await dbPromise.catch(e => false);

            if (!dbResult) {
                showToast('Cloud sync failed, but data is saved locally. You can proceed to print.', 'warning');
            } else {
                showToast('Invoice ' + invoiceData.invNo + ' saved successfully!', 'success');
            }

            // Wait for PDF and other notifications to finish
            await notificationPromise;

            // Show Done Button (Ensure it's visible now)
            document.getElementById('closeStatusBtn').classList.remove('hidden');

            // Print the invoice (Small delay to ensure no-print classes are ready)
            setTimeout(() => {
                window.print();
            }, 500);
        }

        async function saveInvoiceWithStatus(data) {
            updateStepStatus('step-db', 'pending');
            try {
                // Increment the stored invoice number and save locally/cloud
                const currentNum = parseInt(data.invNo.replace(INVOICE_PREFIX, ''));
                localStorage.setItem('lastInvoiceNumber', currentNum);

                await CloudSync.saveInvoice(data);
                updateStepStatus('step-db', 'completed', '‚úÖ');
                return true;
            } catch (error) {
                console.error('Database sync failed:', error);
                updateStepStatus('step-db', 'completed', '‚ùå');
                return false;
            }
        }

        function validateInvoice() {
            const errors = [];

            // Bill To Validation
            const billName = document.getElementById('billName').value.trim();
            const billAddress = document.getElementById('billAddress').value.trim();
            const billState = document.getElementById('billState').value.trim();
            const billMobile = document.getElementById('billMobile').value.trim();
            const billEmail = document.getElementById('billEmail').value.trim();

            if (!billName || billName === 'Customer Name') errors.push('Customer Name is required');
            if (!billAddress || billAddress === 'Address') errors.push('Billing Address is required');
            if (!billState) errors.push('Billing State is required');
            if (!billMobile) errors.push('Billing Mobile Number is required');
            if (!billEmail) errors.push('Billing Email Address is required');

            // Ship To Validation
            const shipName = document.getElementById('shipName').value.trim();
            const shipAddress = document.getElementById('shipAddress').value.trim();
            const shipState = document.getElementById('shipState').value.trim();
            const shipMobile = document.getElementById('shipMobile').value.trim();
            const shipEmail = document.getElementById('shipEmail').value.trim();

            if (!shipName) errors.push('Shipping Name is required');
            if (!shipAddress) errors.push('Shipping Address is required');
            if (!shipState) errors.push('Shipping State is required');
            if (!shipMobile) errors.push('Shipping Mobile is required');
            if (!shipEmail) errors.push('Shipping Email is required');

            // Items Validation
            const rows = document.querySelectorAll('#invoiceItems tr');
            let hasValidItem = false;
            rows.forEach((row, index) => {
                const desc = row.querySelector('.desc')?.value.trim();
                const weight = parseFloat(row.querySelector('.weight')?.value);
                const total = parseFloat(row.querySelector('.total')?.innerText);

                if (desc && !isNaN(weight) && weight > 0) {
                    hasValidItem = true;
                } else if (desc || !isNaN(weight)) {
                    errors.push(`Row ${index + 1}: Description and Weight are required`);
                }
            });

            if (!hasValidItem) errors.push('At least one valid item is required');

            return errors;
        }

        async function startNotificationFlow(invoiceData) {
            try {
                // Step 1: Generate PDF
                updateStepStatus('step-pdf', 'pending');
                const blob = await PDFService.generateInvoicePDF(invoiceData);
                updateStepStatus('step-pdf', 'completed', '‚úÖ');

                // Step 2: Upload to Supabase Storage
                updateStepStatus('step-upload', 'pending');
                try {
                    const filename = `${invoiceData.invNo}_${Date.now()}.pdf`;
                    const publicUrl = await NotificationService.uploadInvoicePDF(blob, filename);
                    updateStepStatus('step-upload', 'completed', '‚úÖ');

                    // Step 3: Send Email Automatically
                    if (invoiceData.billTo.email) {
                        updateStepStatus('step-email', 'pending');
                        const emailResult = await NotificationService.sendInvoiceEmail(invoiceData.billTo.email, publicUrl, invoiceData);
                        if (emailResult === 'sent') {
                            updateStepStatus('step-email', 'completed', '‚úÖ');
                        } else if (emailResult.startsWith('failed')) {
                            const errorDetail = emailResult.split(': ')[1] || 'Unknown Error';
                            updateStepStatus('step-email', 'completed', '‚ö†Ô∏è');
                            showToast(`Email Failed: ${errorDetail}`, 'error');
                        } else {
                            updateStepStatus('step-email', 'completed', '‚è©');
                        }
                    } else {
                        updateStepStatus('step-email', 'completed', '‚è©');
                    }

                    // Step 4: Send SMS Automatically
                    if (invoiceData.billTo.mobile) {
                        updateStepStatus('step-sms', 'pending');
                        const smsResult = await NotificationService.sendInvoiceSMS(invoiceData.billTo.mobile, publicUrl, invoiceData);
                        if (smsResult === 'sent') {
                            updateStepStatus('step-sms', 'completed', '‚úÖ');
                        } else if (smsResult.startsWith('failed')) {
                            const errorDetail = smsResult.split(': ')[1] || 'Unknown Error';
                            updateStepStatus('step-sms', 'completed', '‚ö†Ô∏è');
                            showToast(`SMS Failed: ${errorDetail}`, 'error');
                        } else {
                            updateStepStatus('step-sms', 'completed', '‚è©');
                        }
                    } else {
                        updateStepStatus('step-sms', 'completed', '‚è©');
                    }
                } catch (uploadError) {
                    console.error('Upload or notification failed:', uploadError);
                    updateStepStatus('step-upload', 'completed', '‚ùå');
                    updateStepStatus('step-email', 'completed', '‚ö†Ô∏è');
                    updateStepStatus('step-sms', 'completed', '‚ö†Ô∏è');

                    let errorMsg = uploadError.message;
                    if (window.location.protocol === 'file:') {
                        errorMsg = 'Security Error: You must run this using a "Local Server" (like Live Server in VS Code) for Email/Cloud features to work.';
                    }
                    showToast(errorMsg, 'error');
                }
            } catch (error) {
                console.error('PDF Generation failed:', error);
                updateStepStatus('step-pdf', 'completed', '‚ùå');
                showToast('Failed to generate PDF: ' + error.message, 'error');
                document.getElementById('closeStatusBtn').classList.remove('hidden');
            }
        }

        function updateStepStatus(stepId, status, icon) {
            const step = document.getElementById(stepId);
            step.className = `status-step ${status}`;
            if (icon) {
                step.querySelector('.icon').textContent = icon;
            }
        }

        function closeStatusModal() {
            document.getElementById('notificationStatusModal').classList.remove('active');
            // Reset for next time
            ['step-db', 'step-pdf', 'step-upload', 'step-email', 'step-sms'].forEach(id => {
                const step = document.getElementById(id);
                step.className = 'status-step';
                const originalIcons = { 'step-db': 'üíæ', 'step-pdf': 'üìÑ', 'step-upload': '‚òÅÔ∏è', 'step-email': 'üìß', 'step-sms': 'üì±' };
                step.querySelector('.icon').textContent = originalIcons[id];
            });
            document.getElementById('closeStatusBtn').classList.add('hidden');

            // Show share modal as original behavior
            const invoiceData = collectInvoiceData();
            document.getElementById('savedInvNo').textContent = 'Invoice: ' + invoiceData.invNo + ' | Amount: ' + document.getElementById('grandTotal').innerText;
            document.getElementById('shareModal').classList.add('active');
        }

        function collectInvoiceData() {
            const items = [];
            document.querySelectorAll('#invoiceItems tr').forEach((row, i) => {
                items.push({
                    sr: i + 1,
                    description: row.querySelector('.desc')?.value || '',
                    hsn: row.querySelector('.hsn')?.value || '',
                    metalType: row.querySelector('.metal-type')?.value || '',
                    weight: row.querySelector('.weight')?.value || '',
                    rate: row.querySelector('.rate')?.value || '',
                    mc: row.querySelector('.mc')?.value || '',
                    total: row.querySelector('.total')?.innerText || '0.00'
                });
            });

            const paymentStatus = document.getElementById('paymentStatus').value;
            const paymentMode = document.getElementById('paymentMode').value;
            const invNo = document.getElementById('invNo').value;
            const totalText = document.getElementById('grandTotal').innerText.replace('‚Çπ ', '').trim();
            const total = parseFloat(totalText) || 0;

            // Generate Payment Link
            const upiId = "mantijwewlartpvt@idfcbank";
            const name = "MANTI JEWEL ART PRIVATE LIMITED";
            const note = `Invoice ${invNo}`;
            const paymentLink = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(name)}&am=${total.toFixed(2)}&cu=INR&tn=${encodeURIComponent(note)}`;

            // Capture QR DataURI if status is Pending
            let qrDataUri = null;
            if (paymentStatus === 'Payment Pending') {
                const qrCanvas = document.querySelector('#qrcode canvas');
                if (qrCanvas) qrDataUri = qrCanvas.toDataURL('image/png');
            }

            return {
                invNo: invNo,
                invDate: document.getElementById('invDate').value,
                paymentMode: paymentMode,
                paymentStatus: paymentStatus,
                paymentLink: paymentLink,
                qrDataUri: qrDataUri,
                billTo: {
                    name: document.getElementById('billName').value,
                    address: document.getElementById('billAddress').value,
                    state: document.getElementById('billState').value,
                    gstin: document.getElementById('billGst').value,
                    mobile: document.getElementById('billMobile').value,
                    email: document.getElementById('billEmail').value
                },
                shipTo: {
                    name: document.getElementById('shipName').value,
                    address: document.getElementById('shipAddress').value,
                    state: document.getElementById('shipState').value,
                    mobile: document.getElementById('shipMobile').value,
                    email: document.getElementById('shipEmail').value
                },
                items: items,
                totals: {
                    subTotal: document.getElementById('subTotalTotal')?.innerText || '0.00',
                    cgst: document.getElementById('cgstTotal')?.innerText || '0.00',
                    sgst: document.getElementById('sgstTotal')?.innerText || '0.00',
                    roundOff: document.getElementById('roundOff')?.innerText || '0.00',
                    grandTotal: document.getElementById('grandTotal')?.innerText || '0.00'
                },
                amountInWords: document.getElementById('amountInWords')?.innerText || '',
                savedAt: new Date().toISOString(),
                status: 'saved'
            };
        }

        function saveInvoice(data) {
            // Increment the stored invoice number
            const currentNum = parseInt(data.invNo.replace(INVOICE_PREFIX, ''));
            localStorage.setItem('lastInvoiceNumber', currentNum);

            // Use CloudSync to save
            CloudSync.saveInvoice(data);
        }

        // ===== WHATSAPP & EMAIL =====
        function sendWhatsApp() {
            const invNo = document.getElementById('invNo').value;
            const billName = document.getElementById('billName').value;
            const billMobile = document.getElementById('billMobile').value.replace(/\s+/g, '').replace(/^\+/, '');
            const total = document.getElementById('grandTotal').innerText;
            const date = document.getElementById('invDate').value;

            // Build items summary
            let itemsList = '';
            document.querySelectorAll('#invoiceItems tr').forEach((row, i) => {
                const desc = row.querySelector('.desc')?.value || '';
                const qty = row.querySelector('.qty')?.value || '';
                const rowTotal = row.querySelector('.total')?.innerText || '';
                if (desc) itemsList += `${i + 1}. ${desc} (Qty: ${qty}) - ‚Çπ${rowTotal}\n`;
            });

            const message = `*MANTI JEWEL ART PRIVATE LIMITED*\n` +
                `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                `üìã Invoice: *${invNo}*\n` +
                `üìÖ Date: ${date}\n` +
                `üë§ Customer: ${billName}\n\n` +
                `üì¶ *Items:*\n${itemsList}\n` +
                `üí∞ *Total Amount: ${total}*\n\n` +
                `üè¶ Bank: IDFC FIRST - Pollachi Branch\n` +
                `A/C: 70008000727 | IFSC: IDFB0080538\n` +
                `UPI: mantijwewlartpvt@idfcbank\n\n` +
                `Thank you for your business! üôè`;

            // If mobile number is available, send directly to that number
            const phoneParam = billMobile ? billMobile : '';
            const url = phoneParam
                ? `https://wa.me/${phoneParam}?text=${encodeURIComponent(message)}`
                : `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
            closeShareModal();
        }

        function sendEmail() {
            const invNo = document.getElementById('invNo').value;
            const billName = document.getElementById('billName').value;
            const billEmail = document.getElementById('billEmail').value;
            const total = document.getElementById('grandTotal').innerText;
            const date = document.getElementById('invDate').value;

            const subject = `Invoice ${invNo} - Manti Jewel Art Pvt Ltd`;
            const body = `Dear ${billName},\n\n` +
                `Please find your invoice details below:\n\n` +
                `Invoice No: ${invNo}\n` +
                `Date: ${date}\n` +
                `Total Amount: ${total}\n\n` +
                `Bank Details:\n` +
                `Bank: IDFC FIRST - Pollachi Branch\n` +
                `Account No: 70008000727\n` +
                `IFSC: IDFB0080538\n` +
                `UPI: mantijwewlartpvt@idfcbank\n\n` +
                `Thank you for your business!\n\n` +
                `Regards,\nManti Jewel Art Private Limited\n` +
                `GSTIN: 33AAUCM3607L1Z3`;

            // Use customer email as recipient if available
            const recipient = billEmail || '';
            const url = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = url;
            closeShareModal();
        }

        // ===== ADMIN ACCESS =====
        let pendingAdminAction = null;

        function requestAdminAccess(action) {
            pendingAdminAction = action;
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminModal').classList.add('active');
            setTimeout(() => document.getElementById('adminPassword').focus(), 100);
        }

        function verifyAdmin() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                document.getElementById('adminModal').classList.remove('active');
                if (pendingAdminAction) pendingAdminAction();
                pendingAdminAction = null;
            } else {
                showToast('Invalid admin password!', 'error');
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        }

        function closeAdminModal() {
            document.getElementById('adminModal').classList.remove('active');
            pendingAdminAction = null;
        }

        function closeShareModal() {
            document.getElementById('shareModal').classList.remove('active');
            // Reset form for new invoice
            resetForNewInvoice();
        }

        function resetForNewInvoice() {
            // Get next invoice number
            initInvoiceNumber();
            // Clear form fields
            document.getElementById('billName').value = '';
            document.getElementById('billAddress').value = '';
            document.getElementById('billGst').value = '';
            document.getElementById('billMobile').value = '';
            document.getElementById('billEmail').value = '';
            document.getElementById('shipName').value = '';
            document.getElementById('shipAddress').value = '';
            document.getElementById('shipMobile').value = '';
            document.getElementById('shipEmail').value = '';
            // Reset items table to single empty row
            const tbody = document.getElementById('invoiceItems');
            while (tbody.rows.length > 1) tbody.deleteRow(1);
            const firstRow = tbody.rows[0];
            firstRow.querySelectorAll('input').forEach(i => {
                if (i.classList.contains('hsn')) i.value = '7113';
                else i.value = '';
            });
            firstRow.querySelector('.total').innerText = '0.00';
            firstRow.querySelector('.metal-type').value = 'Pure Gold';
            calculateTotals();
        }

        // ===== UI HELPERS =====
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ===== EXISTING FUNCTIONS =====
        function copyBillToShip() {
            if (document.getElementById('sameAsBill').checked) {
                document.getElementById('shipName').value = document.getElementById('billName').value;
                document.getElementById('shipAddress').value = document.getElementById('billAddress').value;
                document.getElementById('shipState').value = document.getElementById('billState').value;
                document.getElementById('shipMobile').value = document.getElementById('billMobile').value;
                document.getElementById('shipEmail').value = document.getElementById('billEmail').value;
            } else {
                document.getElementById('shipName').value = '';
                document.getElementById('shipAddress').value = '';
                document.getElementById('shipState').value = '';
                document.getElementById('shipMobile').value = '';
                document.getElementById('shipEmail').value = '';
            }
        }

        function calculate(element) {
            const row = element.closest('tr');
            const weight = parseFloat(row.querySelector('.weight').value) || 0;
            const rate = parseFloat(row.querySelector('.rate').value) || 0;
            const mcPercent = parseFloat(row.querySelector('.mc').value) || 0;

            const baseAmount = rate * weight;
            const mcAmount = baseAmount * (mcPercent / 100);
            const total = baseAmount + mcAmount;

            row.querySelector('.total').innerText = total.toFixed(2);
            calculateTotals();
        }

        function calculateTotals() {
            let grandTotal = 0;

            document.querySelectorAll('#invoiceItems tr').forEach(row => {
                grandTotal += parseFloat(row.querySelector('.total').innerText) || 0;
            });

            document.getElementById('subTotalTotal').innerText = grandTotal.toFixed(2);

            // GST calculation (3% default for jewellery)
            const gstRate = 0.03;
            const gstAmt = grandTotal * gstRate;
            document.getElementById('cgstTotal').innerText = (gstAmt / 2).toFixed(2);
            document.getElementById('sgstTotal').innerText = (gstAmt / 2).toFixed(2);

            const totalWithGst = grandTotal + gstAmt;

            // Round off
            const roundedTotal = Math.round(totalWithGst);
            const roundOff = roundedTotal - totalWithGst;
            document.getElementById('roundOff').innerText = roundOff.toFixed(2);

            document.getElementById('grandTotal').innerText = '‚Çπ ' + roundedTotal.toFixed(2);

            // Update Words
            document.getElementById('amountInWords').innerText = numberToWords(roundedTotal) + " Only";

            // Update QR Code
            updateQRCode();
        }

        function updatePaymentUI() {
            const status = document.getElementById('paymentStatus').value;
            const container = document.getElementById('invoice-content');

            if (status === 'Paid') {
                container.classList.add('payment-paid');
                document.getElementById('paymentStatus').className = "bg-transparent border-none p-0 h-5 focus:ring-0 w-full text-xs font-bold text-green-600 no-print";
            } else {
                container.classList.remove('payment-paid');
                document.getElementById('paymentStatus').className = "bg-transparent border-none p-0 h-5 focus:ring-0 w-full text-xs font-bold text-red-600 no-print";
            }
            updateQRCode();
        }

        function updateQRCode() {
            const status = document.getElementById('paymentStatus').value;
            if (status === 'Paid') return;

            const totalText = document.getElementById('grandTotal').innerText.replace('‚Çπ ', '').trim();
            const total = parseFloat(totalText) || 0;
            const invNo = document.getElementById('invNo').value || "INV-00001";

            const upiId = "mantijwewlartpvt@idfcbank";
            const name = "MANTI JEWEL ART PRIVATE LIMITED";
            const note = `Invoice ${invNo}`;

            const url = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(name)}&am=${total.toFixed(2)}&cu=INR&tn=${encodeURIComponent(note)}`;

            const container = document.getElementById('qrcode');
            container.innerHTML = "";

            if (typeof QRCode !== 'undefined') {
                new QRCode(container, {
                    text: url,
                    width: 70,
                    height: 70,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
        }

        function addRow() {
            const tbody = document.getElementById('invoiceItems');
            const newRow = tbody.rows[0].cloneNode(true);
            newRow.querySelectorAll('input').forEach(i => {
                if (i.classList.contains('hsn')) i.value = '7113';
                else if (i.classList.contains('mc')) i.value = '0';
                else i.value = '';
            });
            newRow.querySelector('.metal-type').value = 'Pure Gold';
            newRow.querySelector('.total').innerText = '0.00';
            newRow.cells[0].innerText = tbody.rows.length + 1;
            tbody.appendChild(newRow);
            // Auto-fill rate for the new row
            onMetalTypeChange(newRow.querySelector('.metal-type'));
        }

        function removeRow(btn) {
            if (document.querySelectorAll('#invoiceItems tr').length > 1) {
                btn.closest('tr').remove();
                calculateTotals();
                document.querySelectorAll('#invoiceItems tr').forEach((r, i) => r.cells[0].innerText = i + 1);
            }
        }

        function numberToWords(num) {
            if (num === 0) return "Zero Rupees";

            const a = ['', 'One ', 'Two ', 'Three ', 'Four ', 'Five ', 'Six ', 'Seven ', 'Eight ', 'Nine ', 'Ten ', 'Eleven ', 'Twelve ', 'Thirteen ', 'Fourteen ', 'Fifteen ', 'Sixteen ', 'Seventeen ', 'Eighteen ', 'Nineteen '];
            const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

            const n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
            if (!n) return "";

            let str = "";
            str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'Crore ' : '';
            str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'Lakh ' : '';
            str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'Thousand ' : '';
            str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'Hundred ' : '';
            str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) + '' : '';

            return str + "Rupees";
        }

        // Enter key in admin password field
        document.getElementById('adminPassword').addEventListener('keydown', function (e) {
            if (e.key === 'Enter') verifyAdmin();
        });

        // ===== METAL RATE SYSTEM =====
        function getRateForMetal(metalType) {
            const stored = localStorage.getItem('metalRates');
            if (!stored) return 0;
            const rates = JSON.parse(stored);
            switch (metalType) {
                case 'Pure Gold': return rates.pureGold || 0;
                case 'Pure Silver': return rates.pureSilver || 0;
                case 'Gold(22K)': return rates.gold22k || 0;
                case 'Silver(925)': return rates.silver925 || 0;
                default: return 0;
            }
        }

        function onMetalTypeChange(selectElement) {
            const row = selectElement.closest('tr');
            const metalType = selectElement.value;
            const rate = getRateForMetal(metalType);
            row.querySelector('.rate').value = rate > 0 ? rate.toFixed(2) : '';
            calculate(selectElement);
        }

        function loadRatesForAllRows() {
            document.querySelectorAll('#invoiceItems tr').forEach(row => {
                const metalSelect = row.querySelector('.metal-type');
                if (metalSelect) {
                    const rate = getRateForMetal(metalSelect.value);
                    row.querySelector('.rate').value = rate > 0 ? rate.toFixed(2) : '';
                }
            });
        }
    </script>
</body>

</html>